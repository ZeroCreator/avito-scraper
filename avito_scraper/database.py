import json
from dataclasses import dataclass
from typing import Iterable
import logging

import psycopg

from avito_scraper import settings


@dataclass
class Item:
    """Сущность товара."""

    name: str
    article: int
    url: str
    attrs: dict

    def __eq__(self, other) -> bool:
        """Переопределенный метод для возможности формирования сетов товаров."""
        if isinstance(other, Item):
            return (self.article,) == (
                other.article,
            )
        return False

    def __hash__(self) -> int:
        """Переопределенный метод для возможности формирования сетов товаров."""
        return hash(self.article)


def init_schema() -> None:
    """Инициализирует схему в базу данных."""
    with psycopg.connect(settings.PG_DSN) as connection, psycopg.ClientCursor(
        connection,
    ) as cursor:
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS items (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                name TEXT NOT NULL,
                article BIGINT UNIQUE NOT NULL,
                url TEXT NOT NULL,
                attrs JSONB NOT NULL
            );
        """)
        connection.commit()


def mogrify_items(cursor, items: Iterable[Item]):
    """Формирует список вставляемых значений в базу данных.
    Данный метод является значительно более производительым по сравению с cursor.executemany.
    """
    for item in items:
        yield cursor.mogrify(
            "(%s,%s,%s,%s)",
            (item.name, item.article, item.url, json.dumps(item.attrs)),
        )


def insert_items(items: Iterable[Item]) -> None:
    """Заносит список товаров в базу данных."""
    logging.info(f"Попытка вставить {len(items)} товаров в базу данных.")
    with psycopg.connect(settings.PG_DSN) as connection, psycopg.ClientCursor(
        connection,
    ) as cursor:
        if not items:
            print("Ошибка: список товаров пуст.")
            return  # Завершение выполнения функции, если список пуст
        values = ",".join(mogrify_items(cursor, items))
        try:
            cursor.execute(
                f"""INSERT INTO items (name, article, url, attrs) VALUES {values}
                ON CONFLICT (article) DO UPDATE SET
                name = EXCLUDED.name,
                url = EXCLUDED.url,
                attrs = EXCLUDED.attrs"""
            )
        except Exception as e:
            logging.error(f"Ошибка при вставке данных: {e}")
        connection.commit()

